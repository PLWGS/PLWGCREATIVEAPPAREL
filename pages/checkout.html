<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout - Custom T-Shirt Order | Secure Payment | PLWGS Creative Apparel</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>P</text></svg>">
    <meta name="description" content="Complete your custom t-shirt order securely with PayPal payment. Professional DTG printing with fast shipping. Secure checkout for your custom apparel." />
    
    <!-- Preload critical fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#ff8306',
                        'primary-light': '#ffa726',
                        'primary-dark': '#e65100',
                        'glass-white': 'rgba(255, 255, 255, 0.1)',
                        'glass-black': 'rgba(0, 0, 0, 0.8)',
                        'glass-orange': 'rgba(255, 131, 6, 0.1)',
                        accent: '#ff8306',
                        background: '#000000',
                        surface: '#1a1a1a',
                        'surface-light': '#2a2a2a',
                        'surface-dark': '#0a0a0a',
                        'text-primary': '#ffffff',
                        'text-secondary': '#b3b3b3',
                        success: '#10b981',
                        warning: '#f59e0b',
                        error: '#ef4444'
                    },
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                        'orbitron': ['Orbitron', 'sans-serif']
                    },
                    backdropBlur: {
                        'xs': '2px',
                        'glass': '20px'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'bounce-slow': 'bounce 2s infinite',
                        'pulse-slow': 'pulse 3s infinite',
                        'spin-slow': 'spin 3s linear infinite',
                        'float': 'float 3s ease-in-out infinite',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                        'shimmer': 'shimmer 2s linear infinite',
                        'confetti': 'confetti 0.5s ease-out',
                        'particle': 'particle 4s linear infinite'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-10px)' }
                        },
                        glow: {
                            '0%': { boxShadow: '0 0 5px #ff8306' },
                            '100%': { boxShadow: '0 0 20px #ff8306, 0 0 30px #ff8306' }
                        },
                        shimmer: {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(100%)' }
                        },
                        confetti: {
                            '0%': { transform: 'translateY(0) rotate(0deg)', opacity: '1' },
                            '100%': { transform: 'translateY(-100vh) rotate(360deg)', opacity: '0' }
                        },
                        particle: {
                            '0%': { transform: 'translateY(0) rotate(0deg)', opacity: '1' },
                            '100%': { transform: 'translateY(-100vh) rotate(360deg)', opacity: '0' }
                        }
                    }
                }
            }
        }
    </script>
    
    <script>
        // PayPal integration
        let paypalClientId = null;
        let paypalInitialized = false;
        let paypalScriptLoaded = false;
        
        // Prevent multiple PayPal initializations globally
        if (window.paypalCheckoutInitialized) {
            console.log('‚ö†Ô∏è PayPal checkout already initialized on this page, skipping...');
        } else {
            window.paypalCheckoutInitialized = true;
        }
        
        // Allow PayPal popups by not blocking window.open
        
        // Initialize PayPal function
        function initializePayPal() {
            console.log('üîç Checking PayPal SDK availability...');
            if (typeof paypal === 'undefined') {
                console.error('‚ùå PayPal SDK not loaded');
                return;
            }
            
            if (paypalInitialized) {
                console.log('‚ö†Ô∏è PayPal already initialized, skipping...');
                return;
            }
            
            console.log('‚úÖ PayPal SDK is available, creating buttons...');
            paypalInitialized = true;
            
            const container = document.getElementById('paypal-button-container');
            if (!container) {
                console.error('‚ùå PayPal button container not found');
                return;
            }
            
            // Check if buttons already exist
            if (container.querySelector('[data-paypal-button]')) {
                console.log('‚ö†Ô∏è PayPal buttons already rendered, skipping...');
                return;
            }
            
            // Add a loading indicator
            container.innerHTML = '<div class="loading-spinner"></div><span class="ml-3 text-text-secondary">Loading payment options...</span>';

            paypal.Buttons({
                style: {
                    layout: 'vertical',
                    color: 'blue',
                    shape: 'rect',
                    label: 'pay',
                    height: 45
                },
                enableFunding: 'venmo,paylater,card',
                // Prevent iframe fallback by ensuring popup mode
                intent: 'capture',
                // Add popup handling
                onInit: function(data, actions) {
                    console.log('üé¨ PayPal buttons initialized');
                    // Ensure popup mode is enabled
                    return actions.enable();
                },
                
                // Handle popup opening
                onClick: function(data, actions) {
                    console.log('üñ±Ô∏è PayPal button clicked, opening popup...');
                    // This ensures we're in popup mode, not iframe mode
                    return actions.resolve();
                },
                
                // createOrder: Uses the server-side /api/paypal/create-order endpoint
                createOrder: function(data, actions) {
                    console.log('üé¨ Initiating server-side order creation...');
                    
                    try {
                        if (!validateShippingInfoWithAlerts()) {
                            showMessage('Please complete all required shipping information before proceeding.', 'error');
                            return Promise.reject('Shipping information is invalid.');
                        }

                        const token = localStorage.getItem('customerToken');
                        if (!token) {
                            showMessage('Authentication required. Please log in again.', 'error');
                            return Promise.reject('No authentication token');
                        }
                        
                        // Get form data safely
                        const shippingData = {
                            first_name: document.getElementById('first-name')?.value || '',
                            last_name: document.getElementById('last-name')?.value || '',
                            email: document.getElementById('email')?.value || '',
                            address: document.getElementById('address')?.value || '',
                            city: document.getElementById('city')?.value || '',
                            state: document.getElementById('state')?.value || '',
                            zip: document.getElementById('zip')?.value || '',
                            phone: document.getElementById('phone')?.value || ''
                        };
                        
                        console.log('üì¶ Shipping data:', shippingData);
                        
                        // CRITICAL FIX: Return fetch promise directly (prevents popup)
                        return fetch('/api/paypal/create-order', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                shipping_address: shippingData
                            })
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }
                            return response.json();
                        })
                        .then(order => {
                            if (order.id) {
                                console.log('‚úÖ PayPal Order ID from server:', order.id);
                                return order.id; // Return order ID directly
                            } else {
                                console.error('‚ùå Server failed to create order:', order);
                                showMessage(order.error || 'Failed to create order.', 'error');
                                throw new Error(order.error || 'Failed to create order');
                            }
                        })
                        .catch(error => {
                            console.error('‚ùå Error creating order:', error);
                            showMessage('A network error occurred while creating the order.', 'error');
                            throw error; // Re-throw to prevent popup
                        });
                    } catch (error) {
                        console.error('‚ùå Critical error in createOrder:', error);
                        showMessage('An unexpected error occurred. Please try again.', 'error');
                        return Promise.reject(error);
                    }
                },

                // onApprove: Captures the funds on the server-side
                onApprove: async (data, actions) => {
                    console.log('üëç Order approved by user. Capturing payment on server...');
                    showLoadingOverlay(true);

                    try {
                        const token = localStorage.getItem('customerToken');
                        const response = await fetch('/api/paypal/capture-order', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                orderId: data.orderID 
                            })
                        });

                        const result = await response.json();

                        if (response.ok) {
                            console.log('üéâ Payment captured successfully:', result);
                            processOrder(result.orderNumber, result.finalTotal, 'PayPal');
                            return result;
                        } else {
                            console.error('‚ùå Server failed to capture payment:', result);
                            showMessage(result.error || 'Payment capture failed.', 'error');
                            showLoadingOverlay(false);
                            return Promise.reject(result.error);
                        }
                    } catch (error) {
                        console.error('‚ùå Network error during payment capture:', error);
                        showMessage('A network error occurred while capturing the payment.', 'error');
                        showLoadingOverlay(false);
                        return Promise.reject(error);
                    }
                },

                onError: function(err) {
                    console.error('An error occurred with the PayPal button:', err);
                    
                    // Check if it's a popup blocker error
                    if (err && err.message && err.message.includes('popup')) {
                        console.error('üö´ Popup blocked error detected:', err);
                        showMessage('Popup blocked! Please allow popups for this site and try again.', 'error');
                    } else if (err && err.message && err.message.includes('iframe')) {
                        console.error('üö´ Iframe fallback error detected:', err);
                        showMessage('Payment window failed to open. Please try again.', 'error');
                    } else {
                        showMessage('An unexpected error occurred. Please try again.', 'error');
                    }
                    
                    showLoadingOverlay(false);
                },

                onCancel: function(data) {
                    console.log('Payment was cancelled by the user.');
                    showMessage('Payment was cancelled.', 'warning');
                    showLoadingOverlay(false);
                }
            }).render('#paypal-button-container').then(() => {
                // Mark the container as having PayPal buttons
                const container = document.getElementById('paypal-button-container');
                if (container) {
                    container.setAttribute('data-paypal-button', 'true');
                    console.log('‚úÖ PayPal buttons rendered successfully');
                }
            }).catch((error) => {
                console.error('‚ùå Error rendering PayPal buttons:', error);
                const container = document.getElementById('paypal-button-container');
                if (container) {
                    container.innerHTML = '<div class="text-red-500">Error loading payment options. Please refresh the page.</div>';
                }
            });
        }
        
        // Fetch PayPal Client ID from server
        fetch('/api/paypal/client-id')
            .then(response => response.json())
            .then(data => {
                if (data.clientId) {
                    paypalClientId = data.clientId;
                    loadPayPalSDK();
                }
            })
            .catch(error => {
                console.error('Error loading PayPal Client ID:', error);
            });
        
        function loadPayPalSDK() {
            if (!paypalClientId || paypalScriptLoaded) {
                console.log('‚ö†Ô∏è PayPal SDK already loaded or client ID missing, skipping...');
                return;
            }
            
            // Check if PayPal script is already loaded
            if (document.querySelector('script[src*="paypal.com/sdk/js"]')) {
                console.log('‚ö†Ô∏è PayPal SDK script already exists, skipping...');
                if (typeof paypal !== 'undefined' && !paypalInitialized) {
                    initializePayPal();
                }
                return;
            }
            
            console.log('üîÑ Loading PayPal SDK...');
            paypalScriptLoaded = true;
            const script = document.createElement('script');
            script.src = `https://www.paypal.com/sdk/js?client-id=${paypalClientId}&currency=USD&intent=capture&enable-funding=venmo,paylater,card&disable-funding=credit&components=buttons`;
            
            script.onload = function() {
                console.log('‚úÖ PayPal SDK loaded successfully');
                // Wait a bit for PayPal to fully initialize
                setTimeout(() => {
                    if (typeof paypal !== 'undefined' && !paypalInitialized) {
                        initializePayPal();
                    } else {
                        console.error('‚ùå PayPal SDK not available after loading');
                    }
                }, 100);
            };
            
            script.onerror = function() {
                console.error('‚ùå Failed to load PayPal SDK');
                paypalScriptLoaded = false;
                // Show error message to user
                const container = document.getElementById('paypal-button-container');
                if (container) {
                    container.innerHTML = '<div class="text-red-500">Error loading payment options. Please refresh the page.</div>';
                }
            };
            
            document.head.appendChild(script);
        }
    </script>
    
    <style>
        /* BLACK BACKGROUND BASE */
        body {
            background: #000000;
            color: #ffffff;
            font-family: 'Inter', sans-serif;
        }
        
        /* Glass Morphism - Black Theme */
        .glass {
            backdrop-filter: blur(20px);
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .glass-card {
            backdrop-filter: blur(15px);
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(255, 131, 6, 0.2);
        }
        
        .glass-nav {
            backdrop-filter: blur(25px);
            background: rgba(0, 0, 0, 0.95);
            border-bottom: 1px solid rgba(255, 131, 6, 0.2);
        }
        
        /* ORANGE GRADIENT TEXT */
        .gradient-text {
            background: linear-gradient(135deg, #ff8306, #ffa726, #ffcc80);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .text-gradient {
            background: linear-gradient(135deg, #ff8306, #ffa726, #ffcc80);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* ORANGE BUTTONS - Maximum Impact */
        .btn-primary {
            background: linear-gradient(135deg, #ff8306, #ffa726);
            color: #000000;
            font-weight: 700;
            padding: 1rem 2.5rem;
            border-radius: 50px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(255, 131, 6, 0.5);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }
        
        .btn-primary:hover::before {
            left: 100%;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 15px 40px rgba(255, 131, 6, 0.7);
            background: linear-gradient(135deg, #ffa726, #ffcc80);
        }
        
        /* Secondary Button */
        .btn-secondary {
            background: transparent;
            color: #ff8306;
            border: 2px solid #ff8306;
            font-weight: 600;
            padding: 0.75rem 2rem;
            border-radius: 50px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-secondary:hover {
            background: #ff8306;
            color: #000000;
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(255, 131, 6, 0.4);
        }
        
        /* Particle Animation - Orange on Black */
        .particles-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: #ff8306;
            border-radius: 50%;
            opacity: 0.8;
            animation: float 8s ease-in-out infinite;
        }
        
        /* Checkout Step Styles */
        .checkout-step {
            transition: all 0.3s ease;
            position: relative;
        }
        
        .checkout-step.active {
            border-color: #ff8306;
            background: rgba(255, 131, 6, 0.1);
            box-shadow: 0 0 20px rgba(255, 131, 6, 0.3);
        }
        
        .checkout-step.completed {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }
        
        .checkout-step.required {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);
        }
        
        .checkout-step.required::before {
            content: "Required";
            position: absolute;
            top: -8px;
            right: 10px;
            background: #f59e0b;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .checkout-step.locked {
            opacity: 0.5;
            pointer-events: none;
            border-color: #6b7280;
            background: rgba(107, 114, 128, 0.1);
        }
        
        .checkout-step.locked::before {
            content: "Complete Step 1 First";
            position: absolute;
            top: -8px;
            right: 10px;
            background: #6b7280;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        /* Form Input Styles */
        .form-input {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid rgba(255, 131, 6, 0.3);
            color: #000000;
            transition: all 0.3s ease;
            border-radius: 10px;
        }
        
        .form-input:focus {
            border-color: #ff8306;
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 0 20px rgba(255, 131, 6, 0.3);
            outline: none;
        }
        
        .form-input::placeholder {
            color: rgba(0, 0, 0, 0.5);
        }
        
        /* PayPal Button Container */
        .paypal-button-container {
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 131, 6, 0.2);
            border-radius: 12px;
            padding: 24px;
        }
        
        /* Loading Spinner */
        .loading-spinner {
            border: 2px solid rgba(255, 131, 6, 0.3);
            border-top: 2px solid #ff8306;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Message Styles */
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
        }
        
        .success-message {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #6ee7b7;
        }
        
        /* Progress Indicator */
        .progress-step {
            transition: all 0.3s ease;
        }
        
        .progress-step.active {
            background: #ff8306;
            color: #000000;
        }
        
        .progress-step.completed {
            background: #10b981;
            color: #ffffff;
        }
        
        /* Custom Scrollbar - Orange */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #ff8306;
            border-radius: 4px;
        }
        
        /* Fix PayPal font loading errors */
        @font-face {
            font-family: 'PayPalFont';
            src: local('Arial'), local('Helvetica'), local('sans-serif');
            font-display: swap;
        }
        
        /* Override PayPal's font requests */
        [class*="paypal"] {
            font-family: 'Inter', 'Arial', sans-serif !important;
        }
    </style>
</head>

<body class="overflow-x-hidden">
    <!-- Particle Animation Background -->
    <div class="particles-container" id="particles">
        <!-- Particles will be generated by JavaScript -->
    </div>

    <!-- Navigation Header - Black Glass -->
    <header class="glass-nav fixed top-0 left-0 right-0 z-50 transition-all duration-300">
        <nav class="container mx-auto px-8 py-5">
            <div class="flex items-center justify-between">
                <!-- Logo -->
                <div class="flex items-center space-x-4">
                    <a href="../index.html" class="flex items-center space-x-3">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-r from-primary to-primary-light flex items-center justify-center animate-pulse-orange">
                            <span class="text-black font-orbitron font-black text-xl">P</span>
                        </div>
                        <div>
                            <h1 class="font-orbitron font-black text-xl gradient-text">PLWG'S</h1>
                            <p class="text-xs text-primary font-semibold">CREATIVE APPAREL</p>
                        </div>
                    </a>
                </div>

                <!-- Desktop Navigation -->
                <div class="hidden lg:flex items-center space-x-8">
                    <a href="../index.html" class="text-white hover:text-primary transition-colors font-semibold">Home</a>
                    <a href="shop.html" class="text-white hover:text-primary transition-colors font-semibold">Shop</a>
                    <a href="account.html" class="text-white hover:text-primary transition-colors font-semibold">Account</a>
                    <a href="admin.html" class="text-white hover:text-primary transition-colors font-semibold">Admin</a>
                </div>

                <!-- Cart & User -->
                <div class="flex items-center space-x-4">
                    <a href="cart.html" class="text-white hover:text-primary transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-2.5 5M7 13l2.5 5m6-5v6a2 2 0 11-4 0v-6m4 0V9a2 2 0 10-4 0v4.01"/>
                        </svg>
                    </a>
                    
                    <!-- Mobile Menu Button -->
                    <button class="lg:hidden text-white hover:text-primary transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>
                </div>
            </div>
        </nav>
    </header>

    <!-- Breadcrumb Navigation -->
    <section class="pt-24 pb-6 relative z-10">
        <div class="container mx-auto px-6">
            <nav class="flex items-center space-x-2 text-sm">
                <a href="../index.html" class="text-text-secondary hover:text-primary transition-colors">Home</a>
                <svg class="w-4 h-4 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
                <a href="cart.html" class="text-text-secondary hover:text-primary transition-colors">Cart</a>
                <svg class="w-4 h-4 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
                <span class="text-primary font-semibold">Checkout</span>
            </nav>
        </div>
    </section>

    <!-- Main Content -->
    <main class="pb-16 relative z-10">
        <div class="container mx-auto px-6">
            <div class="max-w-6xl mx-auto">
                <!-- Page Header -->
                <div class="mb-12 text-center">
                    <h1 class="font-orbitron text-5xl font-black text-white mb-4 animate-glow">
                        Secure <span class="text-gradient">Checkout</span>
                    </h1>
                    <p class="text-text-secondary text-xl max-w-2xl mx-auto">
                        Complete your order securely and get ready to wear your creative rebellion
                    </p>
                    
                    <!-- Progress Indicator -->
                    <div class="mt-8 flex items-center justify-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center progress-step active">
                                <span class="font-bold text-sm">1</span>
                            </div>
                            <span class="text-primary font-semibold">Shipping</span>
                        </div>
                        <div class="w-12 h-1 bg-surface-light"></div>
                        <div class="flex items-center space-x-2">
                            <div class="w-10 h-10 rounded-full bg-surface-light flex items-center justify-center progress-step">
                                <span class="text-text-secondary font-bold text-sm">2</span>
                            </div>
                            <span class="text-text-secondary font-semibold">Payment</span>
                        </div>
                    </div>
                    
                    <div class="mt-6 p-4 glass-card rounded-lg border-warning">
                        <p class="text-warning text-sm">
                            <strong>‚ö†Ô∏è Important:</strong> Please complete all required shipping information before proceeding to payment. 
                            Your order cannot be processed without a valid shipping address.
                        </p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
                    <!-- Checkout Steps -->
                    <div class="space-y-8">
                        <!-- Step 1: Shipping Information -->
                        <div class="glass-card rounded-2xl p-8 checkout-step active required" id="step-1">
                            <div class="flex items-center space-x-4 mb-6">
                                <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center">
                                    <span class="text-black font-bold text-sm">1</span>
                                </div>
                                <h3 class="font-orbitron text-2xl font-bold text-white">Shipping Information</h3>
                            </div>
                            
                            <form id="shipping-form" class="space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-semibold text-white mb-3">First Name *</label>
                                        <input type="text" id="first-name" class="form-input w-full px-4 py-3" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-white mb-3">Last Name *</label>
                                        <input type="text" id="last-name" class="form-input w-full px-4 py-3" required>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-white mb-3">Email *</label>
                                    <input type="email" id="email" class="form-input w-full px-4 py-3" required>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-white mb-3">Address *</label>
                                    <input type="text" id="address" class="form-input w-full px-4 py-3" placeholder="Street address" required>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div>
                                        <label class="block text-sm font-semibold text-white mb-3">City *</label>
                                        <input type="text" id="city" class="form-input w-full px-4 py-3" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-white mb-3">State *</label>
                                        <select id="state" class="form-input w-full px-4 py-3" required>
                                            <option value="">Select State</option>
                                            <option value="AL">Alabama</option>
                                            <option value="AK">Alaska</option>
                                            <option value="AZ">Arizona</option>
                                            <option value="AR">Arkansas</option>
                                            <option value="CA">California</option>
                                            <option value="CO">Colorado</option>
                                            <option value="CT">Connecticut</option>
                                            <option value="DE">Delaware</option>
                                            <option value="FL">Florida</option>
                                            <option value="GA">Georgia</option>
                                            <option value="HI">Hawaii</option>
                                            <option value="ID">Idaho</option>
                                            <option value="IL">Illinois</option>
                                            <option value="IN">Indiana</option>
                                            <option value="IA">Iowa</option>
                                            <option value="KS">Kansas</option>
                                            <option value="KY">Kentucky</option>
                                            <option value="LA">Louisiana</option>
                                            <option value="ME">Maine</option>
                                            <option value="MD">Maryland</option>
                                            <option value="MA">Massachusetts</option>
                                            <option value="MI">Michigan</option>
                                            <option value="MN">Minnesota</option>
                                            <option value="MS">Mississippi</option>
                                            <option value="MO">Missouri</option>
                                            <option value="MT">Montana</option>
                                            <option value="NE">Nebraska</option>
                                            <option value="NV">Nevada</option>
                                            <option value="NH">New Hampshire</option>
                                            <option value="NJ">New Jersey</option>
                                            <option value="NM">New Mexico</option>
                                            <option value="NY">New York</option>
                                            <option value="NC">North Carolina</option>
                                            <option value="ND">North Dakota</option>
                                            <option value="OH">Ohio</option>
                                            <option value="OK">Oklahoma</option>
                                            <option value="OR">Oregon</option>
                                            <option value="PA">Pennsylvania</option>
                                            <option value="RI">Rhode Island</option>
                                            <option value="SC">South Carolina</option>
                                            <option value="SD">South Dakota</option>
                                            <option value="TN">Tennessee</option>
                                            <option value="TX">Texas</option>
                                            <option value="UT">Utah</option>
                                            <option value="VT">Vermont</option>
                                            <option value="VA">Virginia</option>
                                            <option value="WA">Washington</option>
                                            <option value="WV">West Virginia</option>
                                            <option value="WI">Wisconsin</option>
                                            <option value="WY">Wyoming</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-white mb-3">ZIP Code *</label>
                                        <input type="text" id="zip" class="form-input w-full px-4 py-3" required>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-white mb-3">Phone Number</label>
                                    <input type="tel" id="phone" class="form-input w-full px-4 py-3">
                                </div>
                            </form>
                            
                            <!-- Success Message -->
                            <div id="shipping-success" class="mt-6 p-4 glass-card border-success rounded-lg" style="display: none;">
                                <div class="flex items-center space-x-3">
                                    <svg class="w-6 h-6 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    <p class="text-success font-semibold">Shipping information completed! You can now proceed to payment.</p>
                                </div>
                            </div>
                            
                            <!-- Continue to Payment Button -->
                            <div class="mt-8 text-center">
                                <button id="continue-to-payment" class="btn-primary w-full py-4 text-lg animate-glow" style="display: none;">
                                    ‚úÖ Continue to Payment
                                </button>
                            </div>
                        </div>

                        <!-- Step 2: Payment Method -->
                        <div class="glass-card rounded-2xl p-8 checkout-step locked" id="step-2">
                            <div class="flex items-center space-x-4 mb-6">
                                <div class="w-10 h-10 rounded-full bg-surface-light flex items-center justify-center">
                                    <span class="text-text-secondary font-bold text-sm">2</span>
                                </div>
                                <h3 class="font-orbitron text-2xl font-bold text-white">Payment Method</h3>
                            </div>
                            
                            <div class="space-y-8">
                                <!-- Locked message -->
                                <div class="locked-message glass-card border-surface-light rounded-lg p-6 text-center">
                                    <div class="text-text-secondary mb-4">
                                        <svg class="w-12 h-12 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                        </svg>
                                        <p class="text-lg">Please complete your shipping information above to proceed with payment</p>
                                    </div>
                                </div>
                                
                                <!-- Payment options (hidden when locked) -->
                                <div class="payment-options">
                                    <div class="glass-card border-primary rounded-lg p-8">
                                        <div class="flex items-center space-x-6 mb-6">
                                            <div class="flex items-center space-x-4">
                                                <!-- Visa Icon -->
                                                <div class="w-16 h-10 bg-gradient-to-r from-blue-600 to-blue-800 rounded-lg flex items-center justify-center shadow-lg">
                                                    <span class="text-white font-bold text-lg tracking-wider">VISA</span>
                                                </div>
                                                <!-- Mastercard Icon -->
                                                <div class="w-16 h-10 bg-gradient-to-r from-red-500 to-orange-500 rounded-lg flex items-center justify-center shadow-lg relative overflow-hidden">
                                                    <div class="absolute left-2 w-6 h-6 bg-red-600 rounded-full"></div>
                                                    <div class="absolute right-2 w-6 h-6 bg-orange-500 rounded-full"></div>
                                                    <div class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 w-4 h-4 bg-white rounded-full"></div>
                                                </div>
                                            </div>
                                            <div>
                                                <span class="text-white font-semibold text-xl">PayPal, Credit & Debit Cards</span>
                                                <p class="text-text-secondary text-base mt-1">Visa, Mastercard, American Express, Discover</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- PayPal Payment -->
                                    <div class="mt-6">
                                        <div class="glass-card p-6">
                                            <h3 class="text-lg font-semibold text-white mb-4">üí≥ Payment Options</h3>
                                            <div id="paypal-button-container" class="paypal-button-container mt-6">
                                                <div class="loading-spinner"></div>
                                                <span class="ml-3 text-text-secondary">Loading payment options...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Order Summary -->
                    <div class="space-y-8">
                        <div class="glass-card rounded-2xl p-8 neon-glow sticky top-32">
                            <h3 class="font-orbitron text-2xl font-bold text-white mb-6">Order Summary</h3>
                            
                            <div id="order-items" class="mb-8">
                                <!-- Order items will be loaded here -->
                            </div>
                            
                            <div class="space-y-4 border-t border-surface-light pt-6">
                                <div class="flex justify-between items-center py-2">
                                    <span class="text-text-secondary text-lg">Subtotal</span>
                                    <span id="subtotal" class="text-white font-semibold text-lg">$0.00</span>
                                </div>
                                <div class="flex justify-between items-center py-2">
                                    <span class="text-text-secondary text-lg">Shipping</span>
                                    <span id="shipping-cost" class="text-white font-semibold text-lg">$0.00</span>
                                </div>
                                <div class="flex justify-between items-center py-2">
                                    <span class="text-text-secondary text-lg">Tax</span>
                                    <span id="tax" class="text-white font-semibold text-lg">$0.00</span>
                                </div>
                                <div class="border-t border-surface-light pt-4">
                                    <div class="flex justify-between items-center">
                                        <span class="text-white font-orbitron font-bold text-xl">Total</span>
                                        <span id="total-price" class="text-primary font-orbitron font-bold text-2xl">$0.00</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Security Notice -->
                        <div class="glass-card rounded-2xl p-6 border-success">
                            <div class="flex items-start space-x-4">
                                <svg class="w-8 h-8 text-success mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <div>
                                    <h4 class="text-success font-semibold text-lg mb-2">Secure Checkout</h4>
                                    <p class="text-text-secondary">Your payment information is encrypted and secure. We never store your payment details.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden">
        <div class="flex items-center justify-center h-full">
            <div class="glass-card rounded-2xl p-8 text-center">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-white text-lg">Processing your order...</p>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Particle Animation
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 50;

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 8 + 's';
                particle.style.animationDuration = (8 + Math.random() * 4) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // Global variables
        let orderData = null;
        let paypalOrderId = null;
        let currentStep = 1;
        let cartItemsForOrder = []; // Store cart items for order success page

        // Check for popup blocker on page load
        function checkPopupBlocker() {
            const testPopup = window.open('', '_blank', 'width=1,height=1');
            if (testPopup) {
                testPopup.close();
                console.log('‚úÖ Popup blocker check passed');
            } else {
                console.warn('‚ö†Ô∏è Popup blocker detected - PayPal payments may not work properly');
                showMessage('Popup blocker detected! Please allow popups for this site to complete payments.', 'warning');
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            createParticles();
            checkAuthentication();
            loadOrderData();
            setupFormValidation();
            checkPopupBlocker(); // Check for popup blocker after functions are defined
        });
        
        // Global error handler to prevent popups from unhandled errors
        window.addEventListener('error', function(event) {
            console.error('üö® Global error caught:', event.error);
            // Prevent any popups from unhandled errors
            event.preventDefault();
            return false;
        });
        
        // Global unhandled promise rejection handler
        window.addEventListener('unhandledrejection', function(event) {
            console.error('üö® Unhandled promise rejection:', event.reason);
            // Prevent any popups from unhandled promise rejections
            event.preventDefault();
            return false;
        });

        // Setup form validation and step management
        function setupFormValidation() {
            const form = document.getElementById('shipping-form');
            const requiredFields = ['first-name', 'last-name', 'email', 'address', 'city', 'state', 'zip', 'phone'];
            
            // Add event listeners to form fields (only on blur, not on input)
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    // Only validate on blur (when user leaves the field), not on every keystroke
                    field.addEventListener('blur', updateStepStatus);
                }
            });
            
            // Add event listener to state field to recalculate tax when changed
            const stateField = document.getElementById('state');
            if (stateField) {
                stateField.addEventListener('change', () => {
                    if (orderData && orderData.items) {
                        displayOrderSummary(orderData.items);
                    }
                });
            }
            
            // Add click handler for continue button
            const continueBtn = document.getElementById('continue-to-payment');
            if (continueBtn) {
                continueBtn.addEventListener('click', () => {
                    // Validate with alerts when user clicks continue
                    if (validateShippingInfoWithAlerts()) {
                        const step2 = document.getElementById('step-2');
                        step2.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                    }
                });
            }
        }

        // Update step status based on form completion
        function updateStepStatus() {
            const step1 = document.getElementById('step-1');
            const step2 = document.getElementById('step-2');
            const lockedMessage = step2.querySelector('.locked-message');
            const paymentOptions = step2.querySelector('.payment-options');
            const continueBtn = document.getElementById('continue-to-payment');
            const successMessage = document.getElementById('shipping-success');
            const isFormComplete = validateShippingInfo();
            
            if (isFormComplete) {
                // Step 1 completed
                step1.classList.remove('required');
                step1.classList.add('completed');
                
                // Unlock Step 2 (Payment)
                step2.classList.remove('locked');
                step2.classList.add('active');
                
                // Show payment options, hide locked message
                if (lockedMessage) lockedMessage.style.display = 'none';
                if (paymentOptions) paymentOptions.style.display = 'block';
                
                // Show success message and continue button
                if (successMessage) successMessage.style.display = 'block';
                if (continueBtn) continueBtn.style.display = 'block';
                
                // Update progress indicator
                updateProgressIndicator(true);
                
                // Auto-scroll to payment section after a short delay
                setTimeout(() => {
                    step2.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 500);
                
                console.log('‚úÖ Shipping information completed - Payment section unlocked');
            } else {
                // Step 1 not completed
                step1.classList.add('required');
                step1.classList.remove('completed');
                
                // Lock Step 2 (Payment)
                step2.classList.add('locked');
                step2.classList.remove('active');
                
                // Show locked message, hide payment options
                if (lockedMessage) lockedMessage.style.display = 'block';
                if (paymentOptions) paymentOptions.style.display = 'none';
                
                // Hide success message and continue button
                if (successMessage) successMessage.style.display = 'none';
                if (continueBtn) continueBtn.style.display = 'none';
                
                // Update progress indicator
                updateProgressIndicator(false);
            }
        }

        // Update progress indicator
        function updateProgressIndicator(shippingComplete) {
            const step1Circle = document.querySelector('.progress-step.active');
            const step2Circle = document.querySelector('.progress-step:not(.active):not(.completed)');
            
            if (shippingComplete) {
                // Mark step 1 as completed
                if (step1Circle) {
                    step1Circle.classList.remove('active');
                    step1Circle.classList.add('completed');
                    step1Circle.innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
                }
                
                // Mark step 2 as active
                if (step2Circle) {
                    step2Circle.classList.add('active');
                    step2Circle.classList.remove('bg-surface-light');
                    step2Circle.classList.add('bg-primary');
                    step2Circle.querySelector('span').classList.remove('text-text-secondary');
                    step2Circle.querySelector('span').classList.add('text-black');
                }
            }
        }

        // Check authentication
        async function checkAuthentication() {
            const token = localStorage.getItem('customerToken');
            if (!token) {
                alert('You must be logged in to checkout. Redirecting to login...');
                window.location.href = 'customer-login.html';
                return;
            }

            try {
                const response = await fetch('/api/customer/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    localStorage.removeItem('customerToken');
                    localStorage.removeItem('customerData');
                    alert('Your session has expired. Please log in again.');
                    window.location.href = 'customer-login.html';
                    return;
                }
            } catch (error) {
                console.error('Authentication check failed:', error);
                alert('Authentication check failed. Please log in again.');
                window.location.href = 'customer-login.html';
            }
        }

        // Load order data from cart and customer profile
        async function loadOrderData() {
            console.log('üöÄ LOAD ORDER DATA CALLED');
            try {
                const token = localStorage.getItem('customerToken');
                console.log('üîë Token found:', token ? 'YES' : 'NO');
                if (!token) {
                    console.log('No customer token found, redirecting to login');
                    window.location.href = 'customer-login.html';
                    return;
                }

                // Load cart data and customer profile in parallel
                console.log('üîÑ Loading order data...');
                const [cartResponse, profileResponse] = await Promise.all([
                    fetch('/api/cart', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch('/api/customer/profile', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                ]);

                console.log('üì¶ Cart response status:', cartResponse.status);
                if (cartResponse.ok) {
                    const cartData = await cartResponse.json();
                    console.log('üì¶ Raw cart data:', cartData);
                    orderData = cartData;
                    
                    // Check if cart has items
                    if (cartData.items && cartData.items.length > 0) {
                        // Store cart items for order success page
                        cartItemsForOrder = cartData.items.map(item => ({
                            name: item.product_name || item.name || 'Unknown Product',
                            size: item.size || 'N/A',
                            color: item.color || 'N/A',
                            price: parseFloat(item.unit_price || item.price || 0),
                            quantity: parseInt(item.quantity || 1)
                        }));
                        console.log('üõí Cart items stored for order success:', cartItemsForOrder);
                        displayOrderSummary(cartData.items);
                    } else {
                        console.log('‚ö†Ô∏è Cart is empty, redirecting to cart page');
                        console.log('üì¶ Cart data structure:', cartData);
                        window.location.href = 'cart.html';
                        return;
                    }
                } else if (cartResponse.status === 401 || cartResponse.status === 403) {
                    console.log('üîê Authentication failed, redirecting to login');
                    console.log('üîê Cart response status:', cartResponse.status);
                    localStorage.removeItem('customerToken');
                    localStorage.removeItem('customerData');
                    window.location.href = 'customer-login.html';
                    return;
                } else {
                    console.error('‚ùå Failed to load cart data:', cartResponse.status);
                    console.error('‚ùå Cart response text:', await cartResponse.text());
                    alert('Failed to load cart data. Redirecting to cart...');
                    window.location.href = 'cart.html';
                    return;
                }

                // Pre-fill shipping form with customer data
                if (profileResponse.ok) {
                    const profileData = await profileResponse.json();
                    prefillShippingForm(profileData);
                } else {
                    console.log('Could not load customer profile, form will be empty');
                }

            } catch (error) {
                console.error('üí• Error loading order data:', error);
                console.error('üí• Error stack:', error.stack);
                alert('Error loading order data. Please try again.');
            }
        }

        // Pre-fill shipping form with customer data
        function prefillShippingForm(profileData) {
            console.log('üë§ Pre-filling shipping form with customer data:', profileData);
            
            const customer = profileData.customer;
            const addresses = profileData.addresses || [];
            
            // Pre-fill basic customer info
            if (customer) {
                const firstNameField = document.getElementById('first-name');
                const lastNameField = document.getElementById('last-name');
                const emailField = document.getElementById('email');
                const phoneField = document.getElementById('phone');
                
                if (firstNameField && customer.first_name) {
                    firstNameField.value = customer.first_name;
                }
                if (lastNameField && customer.last_name) {
                    lastNameField.value = customer.last_name;
                }
                if (emailField && customer.email) {
                    emailField.value = customer.email;
                }
                if (phoneField && customer.phone) {
                    phoneField.value = customer.phone;
                }
            }
            
            // Pre-fill address if available
            if (addresses.length > 0) {
                const defaultAddress = addresses.find(addr => addr.is_default) || addresses[0];
                
                const addressField = document.getElementById('address');
                const cityField = document.getElementById('city');
                const stateField = document.getElementById('state');
                const zipField = document.getElementById('zip');
                
                if (addressField && defaultAddress.address_line1) {
                    addressField.value = defaultAddress.address_line1;
                }
                if (cityField && defaultAddress.city) {
                    cityField.value = defaultAddress.city;
                }
                if (stateField && defaultAddress.state) {
                    stateField.value = defaultAddress.state;
                }
                if (zipField && defaultAddress.postal_code) {
                    zipField.value = defaultAddress.postal_code;
                }
                
                console.log('üè† Pre-filled address:', defaultAddress);
            }
            
            // Trigger validation to update step status
            setTimeout(() => {
                updateStepStatus();
            }, 100);
        }

        // Get tax rate based on state
        function getTaxRateByState(state) {
            const taxRates = {
                'AL': 0.088, // Alabama
                'AK': 0.088, // Alaska
                'AZ': 0.088, // Arizona
                'AR': 0.088, // Arkansas
                'CA': 0.088, // California
                'CO': 0.088, // Colorado
                'CT': 0.088, // Connecticut
                'DE': 0.088, // Delaware
                'FL': 0.088, // Florida
                'GA': 0.088, // Georgia
                'HI': 0.088, // Hawaii
                'ID': 0.088, // Idaho
                'IL': 0.088, // Illinois
                'IN': 0.088, // Indiana
                'IA': 0.088, // Iowa
                'KS': 0.088, // Kansas
                'KY': 0.088, // Kentucky
                'LA': 0.088, // Louisiana
                'ME': 0.088, // Maine
                'MD': 0.088, // Maryland
                'MA': 0.088, // Massachusetts
                'MI': 0.088, // Michigan
                'MN': 0.088, // Minnesota
                'MS': 0.088, // Mississippi
                'MO': 0.088, // Missouri
                'MT': 0.088, // Montana
                'NE': 0.088, // Nebraska
                'NV': 0.088, // Nevada
                'NH': 0.088, // New Hampshire
                'NJ': 0.088, // New Jersey
                'NM': 0.088, // New Mexico
                'NY': 0.088, // New York
                'NC': 0.088, // North Carolina
                'ND': 0.088, // North Dakota
                'OH': 0.088, // Ohio
                'OK': 0.088, // Oklahoma
                'OR': 0.088, // Oregon
                'PA': 0.088, // Pennsylvania
                'RI': 0.088, // Rhode Island
                'SC': 0.088, // South Carolina
                'SD': 0.088, // South Dakota
                'TN': 0.088, // Tennessee
                'TX': 0.088, // Texas
                'UT': 0.088, // Utah
                'VT': 0.088, // Vermont
                'VA': 0.088, // Virginia
                'WA': 0.088, // Washington
                'WV': 0.088, // West Virginia
                'WI': 0.088, // Wisconsin
                'WY': 0.088  // Wyoming
            };
            
            return taxRates[state] || 0.088; // Default to 8.8% if state not found
        }

        // Display order summary
        function displayOrderSummary(cartData) {
            console.log('üõí Displaying order summary with cart data:', cartData);
            
            const orderItemsContainer = document.getElementById('order-items');
            const subtotalElement = document.getElementById('subtotal');
            const shippingElement = document.getElementById('shipping-cost');
            const taxElement = document.getElementById('tax');
            const totalElement = document.getElementById('total-price');

            let subtotal = 0;
            let orderItemsHTML = '';

            cartData.forEach(item => {
                // Convert unit_price to number if it's a string
                const unitPrice = parseFloat(item.unit_price) || 0;
                const itemTotal = item.quantity * unitPrice;
                subtotal += itemTotal;

                orderItemsHTML += `
                    <div class="glass-card rounded-lg p-4 mb-4 border-primary">
                        <div class="flex items-start space-x-4">
                            <img src="${item.image_url || '/placeholder-image.jpg'}" alt="${item.product_name}" class="w-16 h-16 object-cover rounded-lg flex-shrink-0 border-2 border-primary">
                            <div class="flex-1 min-w-0">
                                <h4 class="text-white font-semibold text-base mb-2 leading-tight">${item.product_name}</h4>
                                <div class="space-y-1">
                                    <p class="text-text-secondary text-sm">Size: <span class="text-white font-medium">${item.size || 'N/A'}</span></p>
                                    <p class="text-text-secondary text-sm">Color: <span class="text-white font-medium">${item.color || 'N/A'}</span></p>
                                    <p class="text-text-secondary text-sm">Quantity: <span class="text-white font-medium">${item.quantity}</span></p>
                                </div>
                            </div>
                            <div class="text-right flex-shrink-0">
                                <p class="text-primary font-bold text-lg">$${itemTotal.toFixed(2)}</p>
                                <p class="text-text-secondary text-xs">$${unitPrice.toFixed(2)} each</p>
                            </div>
                        </div>
                    </div>
                `;
            });

            orderItemsContainer.innerHTML = orderItemsHTML;

            // Get shipping method from sessionStorage (set on product page)
            const selectedShipping = sessionStorage.getItem('selectedShippingMethod') || 'standard';
            let shipping = 0;
            
            // Calculate shipping based on selected method
            const selectedShippingCost = sessionStorage.getItem('selectedShippingCost');
            if (selectedShippingCost) {
                shipping = parseFloat(selectedShippingCost);
            } else if (selectedShipping === 'local-pickup') {
                shipping = 0; // FREE
            } else if (selectedShipping === 'standard') {
                shipping = 4.50; // Standard shipping
            } else {
                // Fallback to free over $50, otherwise $5.99
                shipping = subtotal >= 50 ? 0 : 5.99;
            }
            
            // Get tax rate based on shipping address state
            const stateField = document.getElementById('state');
            const state = stateField ? stateField.value : '';
            const taxRate = getTaxRateByState(state);
            const tax = subtotal * taxRate;
            
            // Calculate total
            const total = subtotal + shipping + tax;

            subtotalElement.textContent = `$${subtotal.toFixed(2)}`;
            shippingElement.textContent = shipping === 0 ? 'Free' : `$${shipping.toFixed(2)}`;
            taxElement.textContent = `$${tax.toFixed(2)}`;
            totalElement.textContent = `$${total.toFixed(2)}`;

            // Store calculated values for PayPal
            window.orderTotal = total;
            window.orderSubtotal = subtotal;
            window.orderShipping = shipping;
            window.orderTax = tax;
            
            console.log('üí∞ Order totals calculated:', {
                subtotal: subtotal,
                shipping: shipping,
                tax: tax,
                total: total
            });
        }

        // Validate shipping information (silent - no alerts)
        function validateShippingInfo() {
            const requiredFields = [
                { id: 'first-name', name: 'First Name' },
                { id: 'last-name', name: 'Last Name' },
                { id: 'email', name: 'Email' },
                { id: 'address', name: 'Address' },
                { id: 'city', name: 'City' },
                { id: 'state', name: 'State' },
                { id: 'zip', name: 'ZIP Code' },
                { id: 'phone', name: 'Phone Number' }
            ];

            for (const field of requiredFields) {
                const element = document.getElementById(field.id);
                if (!element || !element.value.trim()) {
                    return false;
                }
            }

            // Validate email format
            const email = document.getElementById('email').value;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                return false;
            }

            // Validate phone format (basic)
            const phone = document.getElementById('phone').value;
            const phoneRegex = /^[\d\s\-\+\(\)]+$/;
            if (!phoneRegex.test(phone) || phone.replace(/\D/g, '').length < 10) {
                return false;
            }

            return true;
        }
        
        // Validate shipping information with alerts (for when user tries to proceed)
        function validateShippingInfoWithAlerts() {
            const requiredFields = [
                { id: 'first-name', name: 'First Name' },
                { id: 'last-name', name: 'Last Name' },
                { id: 'email', name: 'Email' },
                { id: 'address', name: 'Address' },
                { id: 'city', name: 'City' },
                { id: 'state', name: 'State' },
                { id: 'zip', name: 'ZIP Code' },
                { id: 'phone', name: 'Phone Number' }
            ];

            for (const field of requiredFields) {
                const element = document.getElementById(field.id);
                if (!element || !element.value.trim()) {
                    alert(`Please fill in the ${field.name} field.`);
                    element?.focus();
                    return false;
                }
            }

            // Validate email format
            const email = document.getElementById('email').value;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Please enter a valid email address.');
                document.getElementById('email').focus();
                return false;
            }

            // Validate phone format (basic)
            const phone = document.getElementById('phone').value;
            const phoneRegex = /^[\d\s\-\+\(\)]+$/;
            if (!phoneRegex.test(phone) || phone.replace(/\D/g, '').length < 10) {
                alert('Please enter a valid phone number.');
                document.getElementById('phone').focus();
                return false;
            }

            return true;
        }

        
        


        // Process order after successful payment
        async function processOrder(orderNumber, totalAmount, paymentMethod) {
            try {
                // The server has already created the order. We just need to redirect.
                showMessage('Order placed successfully!', 'success');
                
                // Save shipping address for future use
                await saveShippingAddress();
                
                // Redirect to success page with order details
                setTimeout(() => {
                    // Use the stored cart items (captured before order creation)
                    let orderItems = cartItemsForOrder;
                    console.log('üõí Using stored cart items for redirect:', orderItems);
                    console.log('üõí cartItemsForOrder length:', cartItemsForOrder.length);
                    console.log('üõí orderData:', orderData);
                    
                    // Fallback to orderData if cartItemsForOrder is empty
                    if (orderItems.length === 0 && orderData && orderData.items && orderData.items.length > 0) {
                        orderItems = orderData.items.map(item => ({
                            name: item.product_name || item.name || 'Unknown Product',
                            size: item.size || 'N/A',
                            color: item.color || 'N/A',
                            price: parseFloat(item.unit_price || item.price || 0),
                            quantity: parseInt(item.quantity || 1)
                        }));
                        console.log('üõí Fallback to orderData items:', orderItems);
                    }
                    
                    // Encode items for URL
                    const itemsParam = encodeURIComponent(JSON.stringify(orderItems));
                    
                    const redirectUrl = `order-success.html?order=${orderNumber}&total=${totalAmount}&payment=${paymentMethod}&items=${itemsParam}`;
                    
                    console.log('üéâ Redirecting to success page with:', {
                        orderNumber: orderNumber,
                        totalAmount: totalAmount,
                        paymentMethod: paymentMethod,
                        items: orderItems,
                        itemsCount: orderItems.length,
                        redirectUrl: redirectUrl
                    });
                    
                    window.location.href = redirectUrl;
                }, 2000);

            } catch (error) {
                console.error('Error in final processing step:', error);
                showMessage('Error processing order. Please contact support.', 'error');
            } finally {
                showLoadingOverlay(false);
            }
        }

        // Save shipping address for future use
        async function saveShippingAddress() {
            try {
                const token = localStorage.getItem('customerToken');
                if (!token) return;

                const firstName = document.getElementById('first-name').value;
                const lastName = document.getElementById('last-name').value;
                const address = document.getElementById('address').value;
                const city = document.getElementById('city').value;
                const state = document.getElementById('state').value;
                const zip = document.getElementById('zip').value;

                if (!firstName || !lastName || !address || !city || !state || !zip) {
                    console.log('‚ö†Ô∏è Incomplete address data, not saving');
                    return;
                }

                const addressData = {
                    address_type: 'DEFAULT',
                    first_name: firstName,
                    last_name: lastName,
                    address_line1: address,
                    city: city,
                    state: state,
                    postal_code: zip,
                    country: 'United States',
                    is_default: true
                };

                const response = await fetch('/api/customer/profile', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        addresses: [addressData]
                    })
                });

                if (response.ok) {
                    console.log('‚úÖ Shipping address saved for future use');
                } else {
                    console.log('‚ö†Ô∏è Could not save shipping address');
                }
            } catch (error) {
                console.error('Error saving shipping address:', error);
            }
        }

        // Get shipping data from form
        function getShippingData() {
            return {
                first_name: document.getElementById('first-name').value,
                last_name: document.getElementById('last-name').value,
                email: document.getElementById('email').value,
                address: document.getElementById('address').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,
                zip: document.getElementById('zip').value,
                phone: document.getElementById('phone').value
            };
        }

        // Show loading overlay
        function showLoadingOverlay(show) {
            const overlay = document.getElementById('loading-overlay');
            overlay.classList.toggle('hidden', !show);
        }

        // Show message
        function showMessage(message, type) {
            // Remove existing messages
            const existingMessages = document.querySelectorAll('.message-toast');
            existingMessages.forEach(msg => msg.remove());

            // Create new message
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-toast fixed top-4 right-4 z-50 p-4 rounded-lg ${type === 'error' ? 'error-message' : 'success-message'}`;
            messageDiv.textContent = message;

            document.body.appendChild(messageDiv);

            // Auto remove after 5 seconds
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Navbar scroll effect
        window.addEventListener('scroll', () => {
            const navbar = document.querySelector('header');
            if (window.scrollY > 100) {
                navbar.style.background = 'rgba(0, 0, 0, 0.98)';
                navbar.style.backdropFilter = 'blur(25px)';
            } else {
                navbar.style.background = 'rgba(0, 0, 0, 0.95)';
                navbar.style.backdropFilter = 'blur(25px)';
            }
        });

        // Mouse movement particle effect
        document.addEventListener('mousemove', (e) => {
            const particles = document.querySelectorAll('.particle');
            const mouseX = e.clientX / window.innerWidth;
            const mouseY = e.clientY / window.innerHeight;

            particles.forEach((particle, index) => {
                const speed = (index % 3 + 1) * 0.5;
                const x = (mouseX - 0.5) * speed * 20;
                const y = (mouseY - 0.5) * speed * 20;
                
                particle.style.transform = `translate(${x}px, ${y}px)`;
            });
        });
    </script>
<script id="dhws-dataInjector" src="../public/dhws-data-injector.js"></script>
</body>
</html>