<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout - PlwgsCreativeApparel</title>
    <meta name="description" content="Complete your order securely with PayPal payment integration at PlwgsCreativeApparel." />
    <link rel="stylesheet" href="../css/main.css" />
    <script>
        // Get PayPal Client ID from server first, then load PayPal SDK
        let paypalClientId = null;
        
        // Fetch PayPal Client ID from server
        fetch('/api/paypal/client-id')
            .then(response => {
                console.log('üîç PayPal Client ID response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('üîë PayPal Client ID received:', data.clientId);
                console.log('üîë Full response data:', data);
                if (data.clientId) {
                    paypalClientId = data.clientId;
                    // Load PayPal SDK with correct Client ID
                    loadPayPalSDK();
                } else {
                    console.error('‚ùå No PayPal Client ID received');
                    alert('PayPal Client ID not configured. Please contact support.');
                }
            })
            .catch(error => {
                console.error('‚ùå Error loading PayPal Client ID:', error);
                alert('Failed to load payment system. Please refresh the page and try again.');
            });
        
        function loadPayPalSDK() {
            console.log('üöÄ Loading PayPal SDK with Client ID:', paypalClientId);
            
            // Validate PayPal Client ID
            if (!paypalClientId || paypalClientId === 'YOUR_PAYPAL_CLIENT_ID') {
                console.error('‚ùå Invalid PayPal Client ID:', paypalClientId);
                alert('PayPal Client ID not configured properly. Please contact support.');
                return;
            }
            
            // Check PayPal Client ID format (should start with 'A' and be 80 characters)
            if (!paypalClientId.startsWith('A') || paypalClientId.length !== 80) {
                console.error('‚ùå Invalid PayPal Client ID format:', paypalClientId);
                console.error('‚ùå Expected format: starts with A, 80 characters long');
                console.error('‚ùå Actual length:', paypalClientId.length);
                alert('PayPal Client ID format is invalid. Please contact support.');
                return;
            }
            
            // Clean the Client ID (no encoding needed for PayPal Client IDs)
            const cleanClientId = paypalClientId.trim();
            console.log('üîß Cleaned Client ID:', cleanClientId);
            console.log('üîß Client ID length:', cleanClientId.length);
            console.log('üîß Client ID characters:', cleanClientId.split('').map(c => c.charCodeAt(0)).join(','));
            
            // Build URL with minimal parameters first
            const paypalUrl = `https://www.paypal.com/sdk/js?client-id=${cleanClientId}&currency=USD`;
            console.log('üîó PayPal SDK URL (minimal):', paypalUrl);
            
            const script = document.createElement('script');
            script.src = paypalUrl;
            
            script.onload = function() {
                console.log('‚úÖ PayPal SDK loaded successfully');
                // Initialize PayPal after SDK loads
                if (typeof paypal !== 'undefined') {
                    console.log('üéØ Initializing PayPal buttons');
                    initializePayPal();
                } else {
                    console.error('‚ùå PayPal object not available after SDK load');
                }
            };
            script.onerror = function() {
                console.error('‚ùå Failed to load PayPal SDK');
                console.error('‚ùå Failed URL was:', script.src);
                
                // Try alternative approach with different parameters
                console.log('üîÑ Trying alternative PayPal SDK loading...');
                const altScript = document.createElement('script');
                altScript.src = `https://www.paypal.com/sdk/js?client-id=${cleanClientId}&currency=USD&intent=capture`;
                altScript.onload = function() {
                    console.log('‚úÖ Alternative PayPal SDK loaded successfully');
                    if (typeof paypal !== 'undefined') {
                        console.log('üéØ Initializing PayPal buttons with alternative method');
                        initializePayPal();
                    }
                };
                altScript.onerror = function() {
                    console.error('‚ùå Alternative PayPal SDK also failed');
                    alert('Failed to load PayPal payment system. Please refresh the page and try again.');
                };
                document.head.appendChild(altScript);
            };
            document.head.appendChild(script);
        }
    </script>
    <style>
        .glass-card {
            backdrop-filter: blur(15px);
            background: rgba(42, 42, 42, 0.8);
            border: 1px solid rgba(0, 188, 212, 0.2);
        }
        
        .checkout-step {
            transition: all 0.3s ease;
        }
        
        .checkout-step.active {
            border-color: #00bcd4;
            background: rgba(0, 188, 212, 0.1);
        }
        
        .checkout-step.completed {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .checkout-step.required {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }
        
        .checkout-step.required::before {
            content: "Required";
            position: absolute;
            top: -8px;
            right: 10px;
            background: #f59e0b;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .checkout-step.locked {
            opacity: 0.5;
            pointer-events: none;
            border-color: #6b7280;
            background: rgba(107, 114, 128, 0.1);
        }
        
        .checkout-step.locked::before {
            content: "Complete Step 1 First";
            position: absolute;
            top: -8px;
            right: 10px;
            background: #6b7280;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .form-input {
            background: rgba(42, 42, 42, 0.6);
            border: 1px solid rgba(0, 188, 212, 0.3);
            color: white;
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            border-color: #00bcd4;
            background: rgba(42, 42, 42, 0.8);
            box-shadow: 0 0 0 3px rgba(0, 188, 212, 0.1);
        }
        
        .paypal-button-container {
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .loading-spinner {
            border: 2px solid rgba(0, 188, 212, 0.3);
            border-top: 2px solid #00bcd4;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
        }
        
        .success-message {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #6ee7b7;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Header -->
    <header class="fixed top-0 left-0 right-0 z-50 glass-card border-b border-surface-light">
        <div class="container mx-auto px-8 py-5">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <a href="../index.html" class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full bg-accent bg-opacity-20 flex items-center justify-center">
                            <svg class="w-6 h-6 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                        </div>
                        <div>
                            <h1 class="font-orbitron text-xl font-bold text-white">PlwgsCreative</h1>
                            <p class="text-text-secondary text-xs">Apparel</p>
                        </div>
                    </a>
                </div>
                
                <div class="flex items-center space-x-4">
                    <a href="cart.html" class="text-text-secondary hover:text-accent transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-2.5 5M7 13l2.5 5m6-5v6a2 2 0 01-2 2H9a2 2 0 01-2-2v-6m8 0V9a2 2 0 00-2-2H9a2 2 0 00-2 2v4.01"/>
                        </svg>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Breadcrumb Navigation -->
    <section class="pt-24 pb-6 relative z-10">
        <div class="container mx-auto px-6">
            <nav class="flex items-center space-x-2 text-sm">
                <a href="../index.html" class="text-text-secondary hover:text-accent transition-colors">Home</a>
                <svg class="w-4 h-4 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
                <a href="cart.html" class="text-text-secondary hover:text-accent transition-colors">Cart</a>
                <svg class="w-4 h-4 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
                <span class="text-accent">Checkout</span>
            </nav>
        </div>
    </section>

    <!-- Checkout Section -->
    <section class="py-12 relative z-10">
        <div class="container mx-auto px-6">
            <div class="max-w-6xl mx-auto">
                <div class="mb-8">
                    <h1 class="font-orbitron text-4xl font-bold text-white mb-2">Checkout</h1>
                    <p class="text-text-secondary">Complete your order securely</p>
                    
                    <!-- Progress Indicator -->
                    <div class="mt-6 flex items-center justify-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <div class="w-8 h-8 rounded-full bg-accent bg-opacity-20 flex items-center justify-center">
                                <span class="text-accent font-bold text-sm">1</span>
                            </div>
                            <span class="text-text-primary font-medium">Shipping</span>
                        </div>
                        <div class="w-8 h-1 bg-gray-600"></div>
                        <div class="flex items-center space-x-2">
                            <div class="w-8 h-8 rounded-full bg-gray-600 bg-opacity-20 flex items-center justify-center">
                                <span class="text-gray-400 font-bold text-sm">2</span>
                            </div>
                            <span class="text-gray-400 font-medium">Payment</span>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-4 bg-yellow-900 bg-opacity-30 border border-yellow-500 rounded-lg">
                        <p class="text-yellow-200 text-sm">
                            <strong>‚ö†Ô∏è Important:</strong> Please complete all required shipping information before proceeding to payment. 
                            Your order cannot be processed without a valid shipping address.
                        </p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Checkout Steps -->
                    <div class="space-y-6">
                        <!-- Step 1: Shipping Information -->
                        <div class="glass-card rounded-xl p-6 checkout-step active required" id="step-1">
                            <div class="flex items-center space-x-3 mb-4">
                                <div class="w-8 h-8 rounded-full bg-accent bg-opacity-20 flex items-center justify-center">
                                    <span class="text-accent font-bold text-sm">1</span>
                                </div>
                                <h3 class="font-orbitron text-xl font-bold text-white">Shipping Information</h3>
                            </div>
                            
                            <form id="shipping-form" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-text-primary mb-2">First Name *</label>
                                        <input type="text" id="first-name" class="form-input w-full px-4 py-3 rounded-lg" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-text-primary mb-2">Last Name *</label>
                                        <input type="text" id="last-name" class="form-input w-full px-4 py-3 rounded-lg" required>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-text-primary mb-2">Email *</label>
                                    <input type="email" id="email" class="form-input w-full px-4 py-3 rounded-lg" required>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-text-primary mb-2">Address *</label>
                                    <input type="text" id="address" class="form-input w-full px-4 py-3 rounded-lg" placeholder="Street address" required>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-text-primary mb-2">City *</label>
                                        <input type="text" id="city" class="form-input w-full px-4 py-3 rounded-lg" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-text-primary mb-2">State *</label>
                                        <select id="state" class="form-input w-full px-4 py-3 rounded-lg" required>
                                            <option value="">Select State</option>
                                            <option value="AL">Alabama</option>
                                            <option value="AK">Alaska</option>
                                            <option value="AZ">Arizona</option>
                                            <option value="AR">Arkansas</option>
                                            <option value="CA">California</option>
                                            <option value="CO">Colorado</option>
                                            <option value="CT">Connecticut</option>
                                            <option value="DE">Delaware</option>
                                            <option value="FL">Florida</option>
                                            <option value="GA">Georgia</option>
                                            <option value="HI">Hawaii</option>
                                            <option value="ID">Idaho</option>
                                            <option value="IL">Illinois</option>
                                            <option value="IN">Indiana</option>
                                            <option value="IA">Iowa</option>
                                            <option value="KS">Kansas</option>
                                            <option value="KY">Kentucky</option>
                                            <option value="LA">Louisiana</option>
                                            <option value="ME">Maine</option>
                                            <option value="MD">Maryland</option>
                                            <option value="MA">Massachusetts</option>
                                            <option value="MI">Michigan</option>
                                            <option value="MN">Minnesota</option>
                                            <option value="MS">Mississippi</option>
                                            <option value="MO">Missouri</option>
                                            <option value="MT">Montana</option>
                                            <option value="NE">Nebraska</option>
                                            <option value="NV">Nevada</option>
                                            <option value="NH">New Hampshire</option>
                                            <option value="NJ">New Jersey</option>
                                            <option value="NM">New Mexico</option>
                                            <option value="NY">New York</option>
                                            <option value="NC">North Carolina</option>
                                            <option value="ND">North Dakota</option>
                                            <option value="OH">Ohio</option>
                                            <option value="OK">Oklahoma</option>
                                            <option value="OR">Oregon</option>
                                            <option value="PA">Pennsylvania</option>
                                            <option value="RI">Rhode Island</option>
                                            <option value="SC">South Carolina</option>
                                            <option value="SD">South Dakota</option>
                                            <option value="TN">Tennessee</option>
                                            <option value="TX">Texas</option>
                                            <option value="UT">Utah</option>
                                            <option value="VT">Vermont</option>
                                            <option value="VA">Virginia</option>
                                            <option value="WA">Washington</option>
                                            <option value="WV">West Virginia</option>
                                            <option value="WI">Wisconsin</option>
                                            <option value="WY">Wyoming</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-text-primary mb-2">ZIP Code *</label>
                                        <input type="text" id="zip" class="form-input w-full px-4 py-3 rounded-lg" required>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-text-primary mb-2">Phone Number</label>
                                    <input type="tel" id="phone" class="form-input w-full px-4 py-3 rounded-lg">
                                </div>
                            </form>
                            
                            <!-- Success Message -->
                            <div id="shipping-success" class="mt-4 p-4 bg-green-900 bg-opacity-30 border border-green-500 rounded-lg" style="display: none;">
                                <div class="flex items-center space-x-2">
                                    <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    <p class="text-green-200 text-sm font-medium">Shipping information completed! You can now proceed to payment.</p>
                                </div>
                            </div>
                            
                            <!-- Continue to Payment Button -->
                            <div class="mt-6 text-center">
                                <button id="continue-to-payment" class="btn-primary w-full py-3 text-lg" style="display: none;">
                                    ‚úÖ Continue to Payment
                                </button>
                            </div>
                        </div>

                        <!-- Step 2: Payment Method -->
                        <div class="glass-card rounded-xl p-6 checkout-step locked" id="step-2">
                            <div class="flex items-center space-x-3 mb-4">
                                <div class="w-8 h-8 rounded-full bg-accent bg-opacity-20 flex items-center justify-center">
                                    <span class="text-accent font-bold text-sm">2</span>
                                </div>
                                <h3 class="font-orbitron text-xl font-bold text-white">Payment Method</h3>
                            </div>
                            
                            <div class="space-y-4">
                                <!-- Locked message -->
                                <div class="locked-message bg-gray-800 bg-opacity-50 border border-gray-600 rounded-lg p-4 text-center">
                                    <div class="text-gray-400 mb-2">
                                        <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                        </svg>
                                        <p class="text-sm">Please complete your shipping information above to proceed with payment</p>
                                    </div>
                                </div>
                                
                                <!-- Payment options (hidden when locked) -->
                                <div class="payment-options">
                                    <div class="border border-accent border-opacity-30 rounded-lg p-4 bg-accent bg-opacity-5">
                                        <div class="flex items-center space-x-3">
                                            <div class="flex items-center space-x-2">
                                                <img src="https://www.paypalobjects.com/webstatic/mktg/logo/pp_cc_mark_37x23.jpg" alt="PayPal" class="h-6">
                                                <img src="https://www.paypalobjects.com/webstatic/mktg/logo/pp_cc_mark_37x23.jpg" alt="Cards" class="h-6">
                                            </div>
                                            <div>
                                            <span class="text-white font-medium">PayPal, Credit & Debit Cards</span>
                                            <p class="text-text-secondary text-sm">Visa, Mastercard, American Express, Discover</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="paypal-button-container" class="paypal-button-container">
                                    <div class="loading-spinner"></div>
                                    <span class="ml-2 text-text-secondary">Loading payment options...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Order Summary -->
                    <div class="space-y-6">
                        <div class="glass-card rounded-xl p-8">
                            <h3 class="font-orbitron text-2xl font-bold text-white mb-6">Order Summary</h3>
                            
                            <div id="order-items" class="mb-8">
                                <!-- Order items will be loaded here -->
                            </div>
                            
                            <div class="space-y-4 border-t border-surface-light pt-6">
                                <div class="flex justify-between items-center py-2">
                                    <span class="text-text-secondary text-base">Subtotal</span>
                                    <span id="subtotal" class="text-white font-medium text-base">$0.00</span>
                                </div>
                                <div class="flex justify-between items-center py-2">
                                    <span class="text-text-secondary text-base">Shipping</span>
                                    <span id="shipping-cost" class="text-white font-medium text-base">$0.00</span>
                                </div>
                                <div class="flex justify-between items-center py-2">
                                    <span class="text-text-secondary text-base">Tax</span>
                                    <span id="tax" class="text-white font-medium text-base">$0.00</span>
                                </div>
                                <div class="border-t border-surface-light pt-4">
                                    <div class="flex justify-between items-center">
                                        <span class="text-white font-bold text-xl">Total</span>
                                        <span id="total-price" class="text-white font-bold text-2xl">$0.00</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Security Notice -->
                        <div class="glass-card rounded-xl p-6 bg-green-900 bg-opacity-10 border-green-500 border-opacity-20">
                            <div class="flex items-start space-x-3">
                                <svg class="w-6 h-6 text-green-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <div>
                                    <h4 class="text-green-400 font-medium mb-1">Secure Checkout</h4>
                                    <p class="text-text-secondary text-sm">Your payment information is encrypted and secure. We never store your payment details.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center h-full">
            <div class="glass-card rounded-xl p-8 text-center">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-white">Processing your order...</p>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let orderData = null;
        let paypalOrderId = null;
        let currentStep = 1;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            loadOrderData();
            setupFormValidation();
        });

        // Setup form validation and step management
        function setupFormValidation() {
            const form = document.getElementById('shipping-form');
            const requiredFields = ['first-name', 'last-name', 'email', 'address', 'city', 'state', 'zip', 'phone'];
            
            // Add event listeners to form fields (only on blur, not on input)
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    // Only validate on blur (when user leaves the field), not on every keystroke
                    field.addEventListener('blur', updateStepStatus);
                }
            });
            
            // Add click handler for continue button
            const continueBtn = document.getElementById('continue-to-payment');
            if (continueBtn) {
                continueBtn.addEventListener('click', () => {
                    // Validate with alerts when user clicks continue
                    if (validateShippingInfoWithAlerts()) {
                        const step2 = document.getElementById('step-2');
                        step2.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                    }
                });
            }
            
            // Don't run validation on page load - let user fill out form first
            // updateStepStatus() will be called when user tries to proceed
        }

        // Update step status based on form completion
        function updateStepStatus() {
            const step1 = document.getElementById('step-1');
            const step2 = document.getElementById('step-2');
            const lockedMessage = step2.querySelector('.locked-message');
            const paymentOptions = step2.querySelector('.payment-options');
            const continueBtn = document.getElementById('continue-to-payment');
            const successMessage = document.getElementById('shipping-success');
            const isFormComplete = validateShippingInfo();
            
            if (isFormComplete) {
                // Step 1 completed
                step1.classList.remove('required');
                step1.classList.add('completed');
                
                // Unlock Step 2 (Payment)
                step2.classList.remove('locked');
                step2.classList.add('active');
                
                // Show payment options, hide locked message
                if (lockedMessage) lockedMessage.style.display = 'none';
                if (paymentOptions) paymentOptions.style.display = 'block';
                
                // Show success message and continue button
                if (successMessage) successMessage.style.display = 'block';
                if (continueBtn) continueBtn.style.display = 'block';
                
                // Update progress indicator
                updateProgressIndicator(true);
                
                // Auto-scroll to payment section after a short delay
                setTimeout(() => {
                    step2.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 500);
                
                console.log('‚úÖ Shipping information completed - Payment section unlocked');
            } else {
                // Step 1 not completed
                step1.classList.add('required');
                step1.classList.remove('completed');
                
                // Lock Step 2 (Payment)
                step2.classList.add('locked');
                step2.classList.remove('active');
                
                // Show locked message, hide payment options
                if (lockedMessage) lockedMessage.style.display = 'block';
                if (paymentOptions) paymentOptions.style.display = 'none';
                
                // Hide success message and continue button
                if (successMessage) successMessage.style.display = 'none';
                if (continueBtn) continueBtn.style.display = 'none';
                
                // Update progress indicator
                updateProgressIndicator(false);
            }
        }

        // Update progress indicator
        function updateProgressIndicator(shippingComplete) {
            const progressSteps = document.querySelectorAll('.mt-6 .flex .w-8.h-8');
            const progressTexts = document.querySelectorAll('.mt-6 .flex span');
            
            if (shippingComplete) {
                // Mark step 1 as completed
                if (progressSteps[0]) {
                    progressSteps[0].classList.remove('bg-accent', 'bg-opacity-20');
                    progressSteps[0].classList.add('bg-green-500', 'bg-opacity-20');
                }
                if (progressTexts[0]) {
                    progressTexts[0].classList.remove('text-text-primary');
                    progressTexts[0].classList.add('text-green-400');
                }
                
                // Mark step 2 as active
                if (progressSteps[1]) {
                    progressSteps[1].classList.remove('bg-gray-600', 'bg-opacity-20');
                    progressSteps[1].classList.add('bg-accent', 'bg-opacity-20');
                }
                if (progressTexts[1]) {
                    progressTexts[1].classList.remove('text-gray-400');
                    progressTexts[1].classList.add('text-accent');
                }
            } else {
                // Reset to initial state
                if (progressSteps[0]) {
                    progressSteps[0].classList.remove('bg-green-500', 'bg-opacity-20');
                    progressSteps[0].classList.add('bg-accent', 'bg-opacity-20');
                }
                if (progressTexts[0]) {
                    progressTexts[0].classList.remove('text-green-400');
                    progressTexts[0].classList.add('text-text-primary');
                }
                
                if (progressSteps[1]) {
                    progressSteps[1].classList.remove('bg-accent', 'bg-opacity-20');
                    progressSteps[1].classList.add('bg-gray-600', 'bg-opacity-20');
                }
                if (progressTexts[1]) {
                    progressTexts[1].classList.remove('text-accent');
                    progressTexts[1].classList.add('text-gray-400');
                }
            }
        }

        // Check authentication
        async function checkAuthentication() {
            const token = localStorage.getItem('customerToken');
            if (!token) {
                alert('You must be logged in to checkout. Redirecting to login...');
                window.location.href = 'login.html';
                return;
            }

            try {
                const response = await fetch('/api/customer/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    localStorage.removeItem('customerToken');
                    localStorage.removeItem('customerData');
                    alert('Your session has expired. Please log in again.');
                    window.location.href = 'customer-login.html';
                    return;
                }
            } catch (error) {
                console.error('Authentication check failed:', error);
                alert('Authentication check failed. Please log in again.');
                window.location.href = 'login.html';
            }
        }

        // Load order data from cart and customer profile
        async function loadOrderData() {
            try {
                const token = localStorage.getItem('customerToken');
                if (!token) {
                    console.log('No customer token found, redirecting to login');
                    window.location.href = 'customer-login.html';
                    return;
                }

                // Load cart data and customer profile in parallel
                const [cartResponse, profileResponse] = await Promise.all([
                    fetch('/api/cart', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch('/api/customer/profile', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                ]);

                if (cartResponse.ok) {
                    const cartData = await cartResponse.json();
                    orderData = cartData;
                    
                    // Check if cart has items
                    if (cartData.items && cartData.items.length > 0) {
                        displayOrderSummary(cartData.items);
                    } else {
                        console.log('Cart is empty, redirecting to cart page');
                        window.location.href = 'cart.html';
                        return;
                    }
                } else if (cartResponse.status === 401 || cartResponse.status === 403) {
                    console.log('Authentication failed, redirecting to login');
                    localStorage.removeItem('customerToken');
                    localStorage.removeItem('customerData');
                    window.location.href = 'customer-login.html';
                    return;
                } else {
                    console.error('Failed to load cart data:', cartResponse.status);
                    alert('Failed to load cart data. Redirecting to cart...');
                    window.location.href = 'cart.html';
                    return;
                }

                // Pre-fill shipping form with customer data
                if (profileResponse.ok) {
                    const profileData = await profileResponse.json();
                    prefillShippingForm(profileData);
                } else {
                    console.log('Could not load customer profile, form will be empty');
                }

            } catch (error) {
                console.error('Error loading order data:', error);
                alert('Error loading order data. Please try again.');
            }
        }

        // Save shipping address for future use
        async function saveShippingAddress() {
            try {
                const token = localStorage.getItem('customerToken');
                if (!token) return;

                const firstName = document.getElementById('first-name').value;
                const lastName = document.getElementById('last-name').value;
                const address = document.getElementById('address').value;
                const city = document.getElementById('city').value;
                const state = document.getElementById('state').value;
                const zip = document.getElementById('zip').value;

                if (!firstName || !lastName || !address || !city || !state || !zip) {
                    console.log('‚ö†Ô∏è Incomplete address data, not saving');
                    return;
                }

                const addressData = {
                    address_type: 'DEFAULT',
                    first_name: firstName,
                    last_name: lastName,
                    address_line1: address,
                    city: city,
                    state: state,
                    postal_code: zip,
                    country: 'United States',
                    is_default: true
                };

                const response = await fetch('/api/customer/profile', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        addresses: [addressData]
                    })
                });

                if (response.ok) {
                    console.log('‚úÖ Shipping address saved for future use');
                } else {
                    console.log('‚ö†Ô∏è Could not save shipping address');
                }
            } catch (error) {
                console.error('Error saving shipping address:', error);
            }
        }

        // Pre-fill shipping form with customer data
        function prefillShippingForm(profileData) {
            console.log('üë§ Pre-filling shipping form with customer data:', profileData);
            
            const customer = profileData.customer;
            const addresses = profileData.addresses || [];
            
            // Pre-fill basic customer info
            if (customer) {
                const firstNameField = document.getElementById('first-name');
                const lastNameField = document.getElementById('last-name');
                const emailField = document.getElementById('email');
                const phoneField = document.getElementById('phone');
                
                if (firstNameField && customer.first_name) {
                    firstNameField.value = customer.first_name;
                }
                if (lastNameField && customer.last_name) {
                    lastNameField.value = customer.last_name;
                }
                if (emailField && customer.email) {
                    emailField.value = customer.email;
                }
                if (phoneField && customer.phone) {
                    phoneField.value = customer.phone;
                }
            }
            
            // Pre-fill address if available
            if (addresses.length > 0) {
                const defaultAddress = addresses.find(addr => addr.is_default) || addresses[0];
                
                const addressField = document.getElementById('address');
                const cityField = document.getElementById('city');
                const stateField = document.getElementById('state');
                const zipField = document.getElementById('zip');
                
                if (addressField && defaultAddress.address_line1) {
                    addressField.value = defaultAddress.address_line1;
                }
                if (cityField && defaultAddress.city) {
                    cityField.value = defaultAddress.city;
                }
                if (stateField && defaultAddress.state) {
                    stateField.value = defaultAddress.state;
                }
                if (zipField && defaultAddress.postal_code) {
                    zipField.value = defaultAddress.postal_code;
                }
                
                console.log('üè† Pre-filled address:', defaultAddress);
            }
            
            // Trigger validation to update step status
            setTimeout(() => {
                updateStepStatus();
            }, 100);
        }

        // Display order summary
        function displayOrderSummary(cartData) {
            console.log('üõí Displaying order summary with cart data:', cartData);
            
            const orderItemsContainer = document.getElementById('order-items');
            const subtotalElement = document.getElementById('subtotal');
            const shippingElement = document.getElementById('shipping-cost');
            const taxElement = document.getElementById('tax');
            const totalElement = document.getElementById('total-price');

            let subtotal = 0;
            let orderItemsHTML = '';

            cartData.forEach(item => {
                // Convert unit_price to number if it's a string
                const unitPrice = parseFloat(item.unit_price) || 0;
                const itemTotal = item.quantity * unitPrice;
                subtotal += itemTotal;

                orderItemsHTML += `
                    <div class="bg-surface-dark rounded-lg p-4 mb-4">
                        <div class="flex items-start space-x-4">
                            <img src="${item.image_url || '/placeholder-image.jpg'}" alt="${item.product_name}" class="w-16 h-16 object-cover rounded-lg flex-shrink-0">
                            <div class="flex-1 min-w-0">
                                <h4 class="text-white font-medium text-base mb-2 leading-tight">${item.product_name}</h4>
                                <div class="space-y-1">
                                    <p class="text-text-secondary text-sm">Size: <span class="text-white font-medium">${item.size || 'N/A'}</span></p>
                                    <p class="text-text-secondary text-sm">Color: <span class="text-white font-medium">${item.color || 'N/A'}</span></p>
                                    <p class="text-text-secondary text-sm">Quantity: <span class="text-white font-medium">${item.quantity}</span></p>
                                </div>
                            </div>
                            <div class="text-right flex-shrink-0">
                                <p class="text-white font-bold text-lg">$${itemTotal.toFixed(2)}</p>
                                <p class="text-text-secondary text-xs">$${unitPrice.toFixed(2)} each</p>
                            </div>
                        </div>
                    </div>
                `;
            });

            orderItemsContainer.innerHTML = orderItemsHTML;

            // Calculate shipping (free over $50, otherwise $5.99)
            const shipping = subtotal >= 50 ? 0 : 5.99;
            
            // Calculate tax (8.5% for example)
            const tax = subtotal * 0.085;
            
            // Calculate total
            const total = subtotal + shipping + tax;

            subtotalElement.textContent = `$${subtotal.toFixed(2)}`;
            shippingElement.textContent = shipping === 0 ? 'Free' : `$${shipping.toFixed(2)}`;
            taxElement.textContent = `$${tax.toFixed(2)}`;
            totalElement.textContent = `$${total.toFixed(2)}`;

            // Store calculated values for PayPal
            window.orderTotal = total;
            window.orderSubtotal = subtotal;
            window.orderShipping = shipping;
            window.orderTax = tax;
            
            console.log('üí∞ Order totals calculated:', {
                subtotal: subtotal,
                shipping: shipping,
                tax: tax,
                total: total
            });
        }

        // Validate shipping information (silent - no alerts)
        function validateShippingInfo() {
            const requiredFields = [
                { id: 'first-name', name: 'First Name' },
                { id: 'last-name', name: 'Last Name' },
                { id: 'email', name: 'Email' },
                { id: 'address', name: 'Address' },
                { id: 'city', name: 'City' },
                { id: 'state', name: 'State' },
                { id: 'zip', name: 'ZIP Code' },
                { id: 'phone', name: 'Phone Number' }
            ];

            for (const field of requiredFields) {
                const element = document.getElementById(field.id);
                if (!element || !element.value.trim()) {
                    return false;
                }
            }

            // Validate email format
            const email = document.getElementById('email').value;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                return false;
            }

            // Validate phone format (basic)
            const phone = document.getElementById('phone').value;
            const phoneRegex = /^[\d\s\-\+\(\)]+$/;
            if (!phoneRegex.test(phone) || phone.replace(/\D/g, '').length < 10) {
                return false;
            }

            return true;
        }
        
        // Validate shipping information with alerts (for when user tries to proceed)
        function validateShippingInfoWithAlerts() {
            const requiredFields = [
                { id: 'first-name', name: 'First Name' },
                { id: 'last-name', name: 'Last Name' },
                { id: 'email', name: 'Email' },
                { id: 'address', name: 'Address' },
                { id: 'city', name: 'City' },
                { id: 'state', name: 'State' },
                { id: 'zip', name: 'ZIP Code' },
                { id: 'phone', name: 'Phone Number' }
            ];

            for (const field of requiredFields) {
                const element = document.getElementById(field.id);
                if (!element || !element.value.trim()) {
                    alert(`Please fill in the ${field.name} field.`);
                    element?.focus();
                    return false;
                }
            }

            // Validate email format
            const email = document.getElementById('email').value;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Please enter a valid email address.');
                document.getElementById('email').focus();
                return false;
            }

            // Validate phone format (basic)
            const phone = document.getElementById('phone').value;
            const phoneRegex = /^[\d\s\-\+\(\)]+$/;
            if (!phoneRegex.test(phone) || phone.replace(/\D/g, '').length < 10) {
                alert('Please enter a valid phone number.');
                document.getElementById('phone').focus();
                return false;
            }

            return true;
        }

        // Initialize PayPal
        function initializePayPal() {
            console.log('üîç Checking PayPal SDK availability...');
            if (typeof paypal === 'undefined') {
                console.error('‚ùå PayPal SDK not loaded');
                return;
            }
            console.log('‚úÖ PayPal SDK is available, creating buttons...');

            paypal.Buttons({
                style: {
                    layout: 'vertical',
                    color: 'blue',
                    shape: 'rect',
                    label: 'pay',
                    height: 45
                },
                createOrder: function(data, actions) {
                    // Validate shipping information before creating order
                    if (!validateShippingInfoWithAlerts()) {
                        return Promise.reject('Please complete all required shipping information.');
                    }

                    // Validate order data
                    if (!orderData || !orderData.items || !Array.isArray(orderData.items)) {
                        console.error('‚ùå Invalid order data:', orderData);
                        return Promise.reject('Order data is not available. Please refresh the page and try again.');
                    }

                    console.log('üõí Creating PayPal order with items:', orderData.items);

                    return actions.order.create({
                        purchase_units: [{
                            amount: {
                                currency_code: 'USD',
                                value: window.orderTotal.toFixed(2),
                                breakdown: {
                                    item_total: {
                                        currency_code: 'USD',
                                        value: window.orderSubtotal.toFixed(2)
                                    },
                                    shipping: {
                                        currency_code: 'USD',
                                        value: window.orderShipping.toFixed(2)
                                    },
                                    tax_total: {
                                        currency_code: 'USD',
                                        value: window.orderTax.toFixed(2)
                                    }
                                }
                            },
                            items: orderData.items.map(item => ({
                                name: item.product_name,
                                unit_amount: {
                                    currency_code: 'USD',
                                    value: parseFloat(item.unit_price).toFixed(2)
                                },
                                quantity: item.quantity.toString()
                            }))
                        }]
                    });
                },
                onApprove: function(data, actions) {
                    return actions.order.capture().then(function(details) {
                        paypalOrderId = details.id;
                        processOrder(details);
                    });
                },
                onError: function(err) {
                    console.error('PayPal error:', err);
                    showMessage('Payment failed. Please try again.', 'error');
                },
                onCancel: function(data) {
                    console.log('Payment cancelled');
                    showMessage('Payment was cancelled.', 'error');
                }
            }).render('#paypal-button-container');
        }

        // Process order after successful payment
        async function processOrder(paymentDetails) {
            try {
                showLoadingOverlay(true);

                const token = localStorage.getItem('customerToken');
                const shippingData = getShippingData();

                const response = await fetch('/api/orders/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        shipping_address: shippingData,
                        payment_method: 'paypal',
                        payment_id: paypalOrderId,
                        payment_details: paymentDetails
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showMessage('Order placed successfully!', 'success');
                    
                    // Save shipping address for future use
                    await saveShippingAddress();
                    
                    // Redirect to success page with order details
                    setTimeout(() => {
                        const totalAmount = window.orderTotal ? window.orderTotal.toFixed(2) : '0.00';
                        const paymentMethod = 'PayPal';
                        const redirectUrl = `order-success.html?order=${result.orderNumber}&total=$${totalAmount}&payment=${paymentMethod}`;
                        
                        console.log('üéâ Redirecting to success page with:', {
                            orderNumber: result.orderNumber,
                            totalAmount: totalAmount,
                            paymentMethod: paymentMethod,
                            redirectUrl: redirectUrl
                        });
                        
                        window.location.href = redirectUrl;
                    }, 2000);
                } else {
                    const errorData = await response.json();
                    showMessage('Order failed: ' + (errorData.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error processing order:', error);
                showMessage('Error processing order. Please try again.', 'error');
            } finally {
                showLoadingOverlay(false);
            }
        }

        // Get shipping data from form
        function getShippingData() {
            return {
                first_name: document.getElementById('first-name').value,
                last_name: document.getElementById('last-name').value,
                email: document.getElementById('email').value,
                address: document.getElementById('address').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,
                zip: document.getElementById('zip').value,
                phone: document.getElementById('phone').value
            };
        }

        // Validate shipping form
        function validateShippingForm() {
            const requiredFields = ['first-name', 'last-name', 'email', 'address', 'city', 'state', 'zip'];
            
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    showMessage(`Please fill in ${field.placeholder || fieldId.replace('-', ' ')}`, 'error');
                    field.focus();
                    return false;
                }
            }

            // Validate email
            const email = document.getElementById('email').value;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showMessage('Please enter a valid email address', 'error');
                document.getElementById('email').focus();
                return false;
            }

            return true;
        }

        // Show loading overlay
        function showLoadingOverlay(show) {
            const overlay = document.getElementById('loading-overlay');
            overlay.classList.toggle('hidden', !show);
        }

        // Show message
        function showMessage(message, type) {
            // Remove existing messages
            const existingMessages = document.querySelectorAll('.message-toast');
            existingMessages.forEach(msg => msg.remove());

            // Create new message
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-toast fixed top-4 right-4 z-50 p-4 rounded-lg ${type === 'error' ? 'error-message' : 'success-message'}`;
            messageDiv.textContent = message;

            document.body.appendChild(messageDiv);

            // Auto remove after 5 seconds
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Form validation on input
        document.getElementById('shipping-form').addEventListener('input', function() {
            if (validateShippingForm()) {
                document.getElementById('step-1').classList.add('completed');
                document.getElementById('step-2').classList.add('active');
            }
        });
    </script>
<script id="dhws-dataInjector" src="../public/dhws-data-injector.js"></script>
</body>
</html>
