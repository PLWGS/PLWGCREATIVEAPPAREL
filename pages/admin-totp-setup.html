<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin TOTP Setup - PLWGCREATIVEAPPAREL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use locally installed QR code library -->
    <script src="/public/js/qrcode.min.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-2xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-cyan-400 mb-2">üîê TOTP Setup</h1>
                <p class="text-gray-300">Google Authenticator Configuration for Admin Access</p>
            </div>

            <!-- Setup Instructions -->
            <div class="bg-gray-800 rounded-lg p-6 mb-6">
                <h2 class="text-2xl font-semibold text-cyan-400 mb-4">üì± Setup Instructions</h2>
                <ol class="list-decimal list-inside space-y-2 text-gray-300">
                    <li>Download <strong>Google Authenticator</strong> app on your phone</li>
                    <li>Click <strong>"Generate New Secret"</strong> below</li>
                    <li>Scan the QR code with Google Authenticator</li>
                    <li>Enter the 6-digit code to verify setup</li>
                    <li>Both you and your customer can scan the same QR code</li>
                </ol>
            </div>

            <!-- Generate Secret Button -->
            <div class="text-center mb-6">
                <button id="generateSecret" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition-colors">
                    üîë Generate New Secret
                </button>
            </div>

            <!-- TOTP Configuration (Hidden until generated) -->
            <div id="totpConfig" class="hidden bg-gray-800 rounded-lg p-6 mb-6">
                <h3 class="text-xl font-semibold text-cyan-400 mb-4">‚öôÔ∏è TOTP Configuration</h3>
                
                <!-- Secret Key -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Secret Key:</label>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="secretKey" readonly class="bg-gray-700 text-white px-3 py-2 rounded flex-1 font-mono text-sm">
                        <button onclick="copyToClipboard('secretKey', this)" class="bg-gray-600 hover:bg-gray-500 px-3 py-2 rounded text-sm">
                            üìã Copy
                        </button>
                    </div>
                </div>

                <!-- QR Code -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-300 mb-2">QR Code:</label>
                    <div class="bg-white p-4 rounded-lg inline-block">
                        <div id="qrCode"></div>
                    </div>
                    <p class="text-sm text-gray-400 mt-2">Scan this QR code with Google Authenticator</p>
                </div>

                <!-- Manual Entry -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Manual Entry (if QR code doesn't work):</label>
                    <div class="bg-gray-700 p-3 rounded font-mono text-sm">
                        <div><strong>Account:</strong> admin@plwgscreativeapparel.com</div>
                        <div><strong>Key:</strong> <span id="manualKey"></span></div>
                    </div>
                </div>

                <!-- Verification -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Enter 6-digit code to verify:</label>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="verificationCode" placeholder="123456" maxlength="6" class="bg-gray-700 text-white px-3 py-2 rounded flex-1 text-center text-lg font-mono">
                        <button id="verifyCode" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                            ‚úÖ Verify
                        </button>
                    </div>
                </div>

                <!-- Status -->
                <div id="verificationStatus" class="hidden"></div>
            </div>

            <!-- Current Status -->
            <div id="currentStatus" class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-xl font-semibold text-cyan-400 mb-4">üìä Current Status</h3>
                <div id="statusContent">
                    <p class="text-gray-300">Click "Generate New Secret" to begin setup...</p>
                </div>
            </div>

            <!-- Navigation -->
            <div class="text-center mt-8">
                <a href="/pages/admin-login.html" class="text-cyan-400 hover:text-cyan-300 underline">
                    ‚Üê Back to Admin Login
                </a>
            </div>
        </div>
    </div>

    <script>
        let currentSecret = '';
        let currentSecretKey = '';

        // Generate new TOTP secret
        document.getElementById('generateSecret').addEventListener('click', async (event) => {
            const button = event.target;
            const originalText = button.textContent;
            try {
                // Show loading state
                button.textContent = 'üîÑ Generating...';
                button.disabled = true;

                const response = await fetch('/api/admin/totp/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentSecret = data.secret;
                    currentSecretKey = data.secret;
                    
                    // Show configuration
                    document.getElementById('totpConfig').classList.remove('hidden');
                    
                    // Update secret key display
                    document.getElementById('secretKey').value = currentSecretKey;
                    document.getElementById('manualKey').textContent = currentSecretKey;
                    
                    // Generate QR code using the proper library
                    const qrData = `otpauth://totp/PLWGCREATIVEAPPAREL:admin@plwgscreativeapparel.com?secret=${currentSecretKey}&issuer=PLWGCREATIVEAPPAREL`;
                    
                    // Clear previous QR code
                    const qrContainer = document.getElementById('qrCode');
                    qrContainer.innerHTML = '';
                    
                    // Generate proper QR code
                    await QRCode.toCanvas(qrContainer, qrData, {
                        width: 200,
                        margin: 2,
                        color: {
                            dark: '#000000',
                            light: '#FFFFFF'
                        }
                    });
                    
                    // Update status
                    document.getElementById('statusContent').innerHTML = `
                        <p class="text-green-400">‚úÖ New secret generated successfully!</p>
                        <p class="text-gray-300 mt-2">Scan the QR code above with Google Authenticator</p>
                    `;
                } else {
                    throw new Error('Failed to generate secret');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to generate secret. Please try again.');
            } finally {
                // Reset button state
                button.textContent = originalText;
                button.disabled = false;
            }
        });

        // Verify TOTP code
        document.getElementById('verifyCode').addEventListener('click', async () => {
            const code = document.getElementById('verificationCode').value.trim();
            
            if (code.length !== 6) {
                alert('Please enter a 6-digit code');
                return;
            }

            try {
                const response = await fetch('/api/admin/totp/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        secret: currentSecret,
                        code: code
                    })
                });

                const data = await response.json();
                const statusDiv = document.getElementById('verificationStatus');
                
                if (response.ok && data.valid) {
                    statusDiv.innerHTML = `
                        <div class="bg-green-900 border border-green-600 text-green-300 px-4 py-3 rounded">
                            ‚úÖ Code verified successfully! TOTP is now active.
                        </div>
                    `;
                    statusDiv.classList.remove('hidden');
                    
                    // Update status
                    document.getElementById('statusContent').innerHTML = `
                        <p class="text-green-400">‚úÖ TOTP setup completed successfully!</p>
                        <p class="text-gray-300 mt-2">You can now use Google Authenticator for admin login</p>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div class="bg-red-900 border border-red-600 text-red-300 px-4 py-3 rounded">
                            ‚ùå Invalid code. Please try again.
                        </div>
                    `;
                    statusDiv.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to verify code. Please try again.');
            }
        });

        // Copy to clipboard
        function copyToClipboard(elementId, buttonElement) {
            const element = document.getElementById(elementId);
            element.select();
            document.execCommand('copy');
            
            // Show feedback
            const originalText = buttonElement.textContent;
            buttonElement.textContent = '‚úÖ Copied!';
            setTimeout(() => {
                buttonElement.textContent = originalText;
            }, 2000);
        }

        // Check current TOTP status
        async function checkStatus() {
            try {
                const response = await fetch('/api/admin/totp/status');
                if (response.ok) {
                    const data = await response.json();
                    if (data.active) {
                        document.getElementById('statusContent').innerHTML = `
                            <p class="text-green-400">‚úÖ TOTP is currently active</p>
                            <p class="text-gray-300 mt-2">Use Google Authenticator for admin login</p>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error checking status:', error);
            }
        }

        // Check status on page load
        checkStatus();
    </script>
<script id="dhws-dataInjector" src="../public/dhws-data-injector.js"></script>
</body>
</html>
